{% extends 'layouts/base-map.html' %} 
{% block content %}
{% load static %}

<div class="bg-base-white" style="height:calc(100vh - 88px); overflow: hidden;">
  <div class="wrap flex flex-col lg:flex-row h-full overflow-scroll">
    <div class="sm:w-2/5 w-full overflow-y-auto">
      <div class="label-block overflow-scroll">

        <div class="flex justify-start items-center my-6 mx-8">
          <a class="" href="{% url 'home' %}">
          </a>
          <a class="mr-3" href="{% url 'trips:index' %}">
            <i class="fa-solid fa-reply text-xl"></i>
          </a>
          <h1 class="text-2xl font-normal">{{ trip.name }}</h1>
        </div>

        <!-- 日期頁籤 -->
        <div role="tab" class="tabs flex text-start h-14 tabs-bordered overflow-autok">

          <!-- 刪除一天的行程 -->
          <form action="{% url 'trips:schedules:delete_day' trip.id %}" method="post">
            {% csrf_token %}
            <button id="delete-day" class="tab ml-1 h-14 rounded-2xl transition-all ease-in-out text-slate-700 hover:bg-gray-200" >
              <i class="fa-solid fa-minus text-2xl text-red-700"></i>
            </button>
          </form>
          {% for day in date_range %}
            <button id="btn-{{ day|date:'Y-m-d' }}" class="tab ml-1 mb-2 h-14 shadow-sm rounded-2xl transition-all ease-in-out font-bold bg-btn-yellow text-center flex items-center justify-center overflow-hidden text-ellipsis max-w-full px-4"
                    data-date="{{ day|date:'Y-m-d'}}"
                    onclick="showTab('{{ day|date:'Y-m-d' }}', 'btn-{{ day|date:'Y-m-d' }}', '{{ trip.id }}')">
                {{ day|date:"Y-m-d" }}
            </button>
          {% endfor %}
          
          <!-- 新增一天的行程 -->
          <form action="{% url 'trips:schedules:add_day' trip.id %}" method="post">
            {% csrf_token %}
            <button id="add-day" class="tab ml-1 h-14 rounded-2xl transition-all ease-in-out text-slate-700 hover:bg-gray-200" >
              <i class="fa-solid fa-plus text-2xl"></i>
            </button>
          </form>
        </div>

      </div>
      
      <div class="bottom-block overflow-scroll">
        <!-- 行程內容 -->
        {% for date, schedules in schedule_dates.items %}
        <div id="schedule{{ schedules.0.date|date:'Y-m-d' }}" class="tab-content mt-3">
          {% for schedule in schedules %}
          <div class="flex mb-1 px-8 py-3 mx-8 my-6 shadow-lg rounded-custom-20 hover:bg-light-gray h-36">
            <div class="flex grow">
              <a href="{% url 'schedules:show' schedule.id %}" class="w-full h-full flex items-center">
                <span class="inline-block w-6 h-6 mr-2 text-center text-white bg-black rounded-full">{{ forloop.counter }}</span>
                {{ schedule.spot_name }}
                <div class="mx-3 px-2 text-gray-500">{{ schedule.start_time|time:"H:i" }}</div>
              </a>
            </div>
            {% if trip_member.is_editable %}
            <div class="flex grow-0 z-1000" x-data="{ deleteSchedule() {
              Swal.fire({
                icon: 'question',
                title: '確定要刪除嗎?',
                text: '若選擇刪除，資料將會消失',
                showCancelButton: true,
                cancelButtonText: '取消',
                confirmButtonText: '刪除',
              }).then((result) => {
                if(result.isConfirmed){
                  this.$refs['id{{ schedules.id }}'].submit()
                }
              })
            } }">
              <a class="px-2 py-2 rounded-lg hover:text-gray-650 text-cyan-850" href="{% url 'schedules:update' schedule.id %}"><i class="fa-solid fa-file-pen"></i></a>
              <form @submit.prevent="deleteSchedule()" action="{% url 'schedules:delete' schedule.id %}" method="post" x-ref="id{{ schedules.id }}">
                {% csrf_token %}
                <button class="px-2 py-2 text-red-700 rounded-lg hover:text-gray-650"><i class="fa-regular fa-trash-can"></i></button>
              </form>
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        {% endfor %}
        
        <!-- 新增景點按鈕 -->
        <div class="flex justify-center my-10">
          {% if trip_member.is_editable %}
            <a class="px-28 py-4 text-white border rounded-custom-50 bg-blue-btn hover:bg-blue-dc text-xl font-medium" href="{% url 'spots:index' %}">新增景點</a>
          {% endif %}
        </div>
        <div class="border-light-gray border"></div>
        <!-- 成員列表 -->
        <div class="flex justify-start pl-8 text-2xl mt-12 mb-8">
          <div>成員列表</div>  
        </div>
          {% for member in members %}
            <div class="flex justify-between items-center px-2 py-3 mx-8 my-4 bg-white border rounded-lg hover:bg-light-gray h-100" x-data="{ deleteMember(m) {
              Swal.fire({
                icon: 'question',
                title: '確定要刪除成員嗎?',
                showCancelButton: true,
                cancelButtonText: '取消',
                confirmButtonText: '刪除',
              }).then((result) => {
                if(result.isConfirmed){
                  this.$refs[`${m}`].submit()
                }
              })
            } }">
              
              <div class="flex items-center">
                {{ member.email }}
              </div>

              {% if trip_member.member_id == member.id %}
                <form @submit.prevent="deleteMember('self')" action="{% url 'trips:delete-self' trip.id member.id %}" method="post" x-ref="self">
                  {% csrf_token %}
                  <input type="submit" value="X">
                </form>
              {% elif trip_member.is_editable and member.id != trip.owner %}
                <form @submit.prevent="deleteMember('id{{ member.id }}')" action="{% url 'trips:delete-member' trip.id member.id %}" method="post" x-ref="id{{ member.id }}">
                  {% csrf_token %}
                  <input type="submit" value="X">
                </form>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
      <div id="map" style="flex-grow: 1;" class="hidden sm:block h-[80vh] m-2 sm:h-full border border-gray-500 sm border-none sm:m-0"></div>
      <span id="loading-spinner" class="absolute loading loading-ball loading-lg top-1/2 translate-y-[-50%] left-1/2 translate-x-[-50%] "></span>

  </div>
</div>
<link rel="stylesheet" href="{% static "styles/route.css" %}">
<link rel="stylesheet" href="{% static "styles/wait_web.css" %}">

<script src="{% static "scripts/route.js" %}"></script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=places&callback=initMap" async defer></script>
{% endblock %}